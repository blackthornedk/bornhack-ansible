---
- name: Install mailman
  become: yes
  pkgng:
    name=mailman
    state=present

- name: Enable mailman
  become: yes
  service:
    name=mailman
    enabled=yes

- name: Install postfix-to-mailman.py
  become: yes
  copy:
    owner=mailman
    group=mailman
    mode=740
    src=postfix-to-mailman.py
    dest=/usr/local/mailman/postfix-to-mailman.py

- name: Add postfix-to-mailman.py to master.cf
  become: yes
  blockinfile:
    create: yes
    dest: /usr/local/etc/postfix/master.cf
    marker: "# {mark} ANSIBLE MANAGED BLOCK mailman integration"
    content: |
      mailman unix - n n - - pipe
        flags=FR user=mailman:mailman
        argv=/usr/local/mailman/postfix-to-mailman.py ${nexthop} ${user}

- name: Configure mailman DEFAULT_EMAIL_HOST
  become: yes
  lineinfile:
    dest=/usr/local/mailman/Mailman/Defaults.py
    regexp="^DEFAULT_EMAIL_HOST = "
    line="DEFAULT_EMAIL_HOST = '{{ postfix_virtual_alias_domain }}'"

- name: Configure mailman DEFAULT_URL_HOST
  become: yes
  lineinfile:
    dest=/usr/local/mailman/Mailman/Defaults.py
    regexp="^DEFAULT_URL_HOST = "
    line="DEFAULT_URL_HOST = '{{ ansible_nodename }}'"

- name: Configure mailman DEFAULT_URL_PATTERN
  become: yes
  lineinfile:
    dest=/usr/local/mailman/Mailman/Defaults.py
    regexp="^DEFAULT_URL_PATTERN = "
    line="DEFAULT_URL_PATTERN = 'https://%s/mailman/'"

- name: Fix permissions on mailman private archive dir
  become: yes
  file:
    path=/usr/local/mailman/archives/private
    state=directory
    mode=02770

- name: generate mailman list password
  shell: "openssl rand -base64 33 | tr -d '='"
  args:
    creates: "/usr/local/mailman/lists/mailman"
  register: password

- name: Create mailman mailing lists
  become: yes
  shell: "/usr/local/mailman/bin/newlist -a mailman {{ mailman_list_owner }} {{ password.stdout }}"
  args:
    creates: "/usr/local/mailman/lists/mailman"

- name: Create virtual for mailman mailinglist
  become: yes
  blockinfile:
    create: yes
    dest: /usr/local/etc/postfix/mailman-virtual
    marker: "# {mark} ANSIBLE MANAGED BLOCK mailman mailinglist"
    content: |
      ## mailman mailing list
      mailman@{{ postfix_virtual_alias_domain }}              mailman
      mailman-admin@{{ postfix_virtual_alias_domain }}        mailman-admin
      mailman-bounces@{{ postfix_virtual_alias_domain }}      mailman-bounces
      mailman-confirm@{{ postfix_virtual_alias_domain }}      mailman-confirm
      mailman-join@{{ postfix_virtual_alias_domain }}         mailman-join
      mailman-leave@{{ postfix_virtual_alias_domain }}        mailman-leave
      mailman-owner@{{ postfix_virtual_alias_domain }}        mailman-owner
      mailman-request@{{ postfix_virtual_alias_domain }}      mailman-request
      mailman-subscribe@{{ postfix_virtual_alias_domain }}    mailman-subscribe
      mailman-unsubscribe@{{ postfix_virtual_alias_domain }}  mailman-unsubscribe

- name: Start mailman
  become: yes
  service:
    name=mailman
    state=started

- name: generate mailinglist passwords
  shell: "openssl rand -base64 33 | tr -d '='"
  args:
    creates: "/usr/local/mailman/lists/{{ item.key }}"
  register: passwords
  with_dict: "{{ lists }}"

- name: Create mailinglists
  become: yes
  shell: "/usr/local/mailman/bin/newlist -a {{ item.0 }} {{ lists[item.0] }} {{ item.1.stdout }}"
  args:
    creates: "/usr/local/mailman/lists/{{ item.0 }}"
  with_together:
    - "{{ lists }}"
    - "{{ passwords.results }}"

- name: Create virtual for mailman mailinglist
  become: yes
  blockinfile:
    create: yes
    dest: /usr/local/etc/postfix/mailman-virtual
    marker: "# {mark} ANSIBLE MANAGED BLOCK {{ item.key }} mailinglist"
    content: |
      ## mailman mailing list
      {{ item.key }}@{{ postfix_virtual_alias_domain }}              {{ item.key }}
      {{ item.key }}-admin@{{ postfix_virtual_alias_domain }}        {{ item.key }}-admin
      {{ item.key }}-bounces@{{ postfix_virtual_alias_domain }}      {{ item.key }}-bounces
      {{ item.key }}-confirm@{{ postfix_virtual_alias_domain }}      {{ item.key }}-confirm
      {{ item.key }}-join@{{ postfix_virtual_alias_domain }}         {{ item.key }}-join
      {{ item.key }}-leave@{{ postfix_virtual_alias_domain }}        {{ item.key }}-leave
      {{ item.key }}-owner@{{ postfix_virtual_alias_domain }}        {{ item.key }}-owner
      {{ item.key }}-request@{{ postfix_virtual_alias_domain }}      {{ item.key }}-request
      {{ item.key }}-subscribe@{{ postfix_virtual_alias_domain }}    {{ item.key }}-subscribe
      {{ item.key }}-unsubscribe@{{ postfix_virtual_alias_domain }}  {{ item.key }}-unsubscribe
  with_dict: "{{ lists }}"

- name: Reload Postfix
  become: yes
  service:
    name=postfix
    state=reloaded
